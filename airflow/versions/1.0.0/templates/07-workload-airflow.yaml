kind: workload
name: {{ .Values.airflow.webserverName }}
description: {{ .Values.airflow.webserverName }}
gvc: {{ .Values.gvc.name }}
tags:
  {{- include "pg.tags" . | nindent 4 }}
spec:
  type: stateful
  identityLink: //identity/{{ include "pg.name" . }}
  containers:
    - name: airflow
      command: bash
      args:
        - '-c'
        - |-
          mkdir -p /opt/airflow/dags;
          airflow db migrate;
          airflow dag-processor &
          airflow scheduler &
          airflow triggerer &
          exec airflow api-server
      cpu: {{ .Values.airflow.webserver.resources.cpu }}
      memory: {{ .Values.airflow.webserver.resources.memory }}
      image: apache/airflow:3.0.3
      inheritEnv: false
      lifecycle:
        preStop:
          exec:
            command:
              - bash
              - '-c'
              - sleep 0
      env:
        - name: AIRFLOW_HOME
          value: /opt/airflow
        - name: AIRFLOW__API_AUTH__JWT_EXPIRATION_DELTA
          value: "{{ .Values.airflow.auth.jwtExpirationDelta }}"
        - name: AIRFLOW__API_AUTH__JWT_REFRESH_THRESHOLD
          value: "{{ .Values.airflow.auth.jwtRefreshThreshold }}"
        - name: POSTGRES_USERNAME
          value: cpln://secret/{{ include "pg.secretName" . }}.username         
        - name: POSTGRES_PASSWORD 
          value: cpln://secret/{{ include "pg.secretName" . }}.password          
        - name: AIRFLOW__API_AUTH__JWT_SECRET
          value: {{ .Values.airflow.auth.jwtSecret }}
        - name: AIRFLOW__API__BASE_URL
          value: http://{{ .Values.airflow.webserverName}}:{{ .Values.airflow.webPort }}
        - name: AIRFLOW__CELERY__BROKER_URL
          value: redis://{{ .Values.redis.name }}.{{ .Values.gvc.name }}.cpln.local
        - name: AIRFLOW__CELERY__RESULT_BACKEND
          value: db+postgresql://$(POSTGRES_USERNAME):$(POSTGRES_PASSWORD)@{{ .Values.postgres.name }}:5432/{{ .Values.postgres.config.database }}
        - name: AIRFLOW__CORE__DAGS_FOLDER
          value: /opt/airflow/dags
        - name: AIRFLOW__CORE__EXECUTOR
          value: CeleryExecutor
        - name: AIRFLOW__DATABASE__SQL_ALCHEMY_CONN
          value: postgresql+psycopg2://$(POSTGRES_USERNAME):$(POSTGRES_PASSWORD)@{{ .Values.postgres.name }}:5432/{{ .Values.postgres.config.database }}
        - name: AIRFLOW__LOGGING__REMOTE_LOGGING
          value: 'False'
        - name: AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL
          value: "{{ .Values.airflow.scheduler.dagDirListInterval }}"
        - name: AIRFLOW__SCHEDULER__MIN_FILE_PROCESS_INTERVAL
          value: "{{ .Values.airflow.scheduler.minFileProcessInterval }}"
        - name: AIRFLOW__WEBSERVER__WEB_SERVER_HOST
          value: 0.0.0.0
        - name: AIRFLOW__WEBSERVER__WEB_SERVER_PORT
          value: "{{ .Values.airflow.webPort }}"
      ports:
        - number: {{ .Values.airflow.webPort }}
          protocol: http
      volumes:
        - path: /opt/airflow
          recoveryPolicy: retain
          uri: cpln://volumeset/{{ .Values.airflow.webserverName }}
  {{- if or .Values.airflow.webserver.inboundAllowCIDR .Values.airflow.webserver.outboundAllowCIDR }}
  firewallConfig:
    external:      
      {{- if .Values.airflow.webserver.inboundAllowCIDR }}
      inboundAllowCIDR:
        {{- range .Values.airflow.webserver.inboundAllowCIDR }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}

      {{- if .Values.airflow.webserver.outboundAllowCIDR }}
      outboundAllowCIDR:
        {{- range .Values.airflow.webserver.outboundAllowCIDR }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
    internal:
      inboundAllowType: same-gvc
      inboundAllowWorkload: []
  {{- else }}
  firewallConfig:
    internal:
      inboundAllowType: same-gvc
      inboundAllowWorkload: []
  {{- end }}      

  loadBalancer:
    direct:
      enabled: false
      ports: []
    replicaDirect: false

  rolloutOptions:
    maxSurgeReplicas: 25%
    minReadySeconds: 0
    scalingPolicy: OrderedReady
    terminationGracePeriodSeconds: 1

  securityOptions:
    filesystemGroupId: 50000

  supportDynamicTags: false

