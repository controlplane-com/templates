---
kind: secret
name: clickhouse-server-startup
description: Clickhouse server startup script
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # Runtime variables
    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}
    GVC="{{ .Values.gvc.name }}"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    WORKLOAD_NAME="{{ .Release.Name }}-server"

    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"

    echo "Starting ClickHouse server for replica ${SELF_FQDN}"

    # Generate remote_servers.xml dynamically
    echo "<remote_servers>" > /etc/clickhouse-server/remote_servers.xml
    echo "  <my_cluster>" >> /etc/clickhouse-server/remote_servers.xml

    # Loop through locations and replicas using Helm template
    {{- range .Values.gvc.locations }}
      {{- $loc := .name }}
      {{- $replicas := int .replicas }}
      <shard>
      {{- range $i, $_ := until $replicas }}
        <replica>
          <host>replica-{{$i}}.{{ $.Release.Name }}-server.{{$loc}}.{{ $.Values.gvc.name }}.cpln.local</host>
          <port>9000</port>
        </replica>
      {{- end }}
      </shard>
    {{- end }}


    echo "  </my_cluster>" >> /etc/clickhouse-server/remote_servers.xml
    echo "</remote_servers>" >> /etc/clickhouse-server/remote_servers.xml

    # Generate zookeeper.xml pointing to all Keeper replicas (adjust as needed)
    echo "<zookeeper>" > /etc/clickhouse-server/zookeeper.xml
    {{- range $i, $loc := .Values.gvc.locations }}
      {{- $replicas := int $loc.replicas }}   # cast to int here
      {{- range $j, $_ := until $replicas }}
        <node>
          <host>replica-{{$j}}.{{ $.Release.Name }}-keeper.{{$loc.name}}.{{ $.Values.gvc.name }}.cpln.local</host>
          <port>9181</port>
        </node>
      {{- end }}
    {{- end }}
    echo "</zookeeper>" >> /etc/clickhouse-server/zookeeper.xml

    echo "sleeping for 60 seconds"
    sleep 60

    # Start ClickHouse server
    exec clickhouse-server \
      --config-file=/etc/clickhouse-server/config.xml \
      --users-file=/etc/clickhouse-server/users.xml
