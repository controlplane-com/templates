---
kind: secret
name: dbeaver-config
description: dbeaver config
type: dictionary
data:
  admin_name: {{ .Values.admin.name }}
  admin_password: {{ .Values.admin.password }}
  user: {{ .Values.database.user }}
  password: {{ .Values.database.password }}
  driver: {{ .Values.database.driver }}
  url: {{ .Values.database.url }}

---
kind: secret
name: dbeaver-init
description: dbeaver startup script
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    sleep 30
    echo 'sleeping for 30 seconds'

    # Values injected by Helm
    ADMIN_USER="{{ .Values.admin.name }}"
    ADMIN_PASS="{{ .Values.admin.password }}"

    DEFAULT_USER="default_user"
    DEFAULT_PASS="Password123"  # Or inject via Helm if you want it configurable

    CONF_DIR="/opt/cloudbeaver/conf"

    # Write initial-data.conf with admin and default user
    cat > "$CONF_DIR/initial-data.conf" <<EOF
    {
      "teams": [
        {
          "subjectId": "admin",
          "teamName": "Admin",
          "description": "Administrative access. Has all permissions.",
          "permissions": ["admin"]
        },
        {
          "subjectId": "user",
          "teamName": "User",
          "description": "All users, including anonymous.",
          "permissions": []
        }
      ],
      "users": [
        {
          "subjectId": "$ADMIN_USER",
          "name": "Administrator",
          "password": "$ADMIN_PASS",
          "teams": ["admin"]
        },
        {
          "subjectId": "$DEFAULT_USER",
          "name": "Default User",
          "password": "$DEFAULT_PASS",
          "teams": ["user"]
        }
      ]
    }
    EOF

    echo 'initial-data.conf written with admin and default user'
    ls -l "$CONF_DIR"
    cat "$CONF_DIR/initial-data.conf"

    # Start CloudBeaver server
    exec /opt/cloudbeaver/run-server.sh
