kind: secret
name: {{ include "opensearch.secretStartup.name" . }}
description: OpenSearch startup script
tags: {{ include "opensearch.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: >-
    #!/bin/bash

    set -e

        # --- Install required plugins ---
    {{- if .Values.backup.enabled }}

    echo "Installing repository plugins..."
    
    {{- if and .Values.backup.enabled (eq .Values.backup.provider "aws") }}

    # Install S3 repository plugin

    /usr/share/opensearch/bin/opensearch-plugin install --batch repository-s3

    {{- else if and .Values.backup.enabled (eq .Values.backup.provider "gcp") }}

    # Install GCS repository plugin

    /usr/share/opensearch/bin/opensearch-plugin install --batch repository-gcs
    
    {{- end }}
    
    echo "Plugins installed successfully"
    {{- end }}

    # --- Construct NODE_NAME list ---

    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    LOCATION=$(basename "${CPLN_LOCATION}")

    NODE_NAME="replica-${REPLICA_INDEX}.{{ include "opensearch.name" . }}.${LOCATION}.{{ .Values.global.cpln.gvc }}.cpln.local"


    echo "Starting OpenSearch node: ${NODE_NAME}"


    # --- Generate config file ---

    cat <<EOF > /usr/share/opensearch/config/opensearch.yml

    cluster.name: {{ .Values.clusterName }}

    node.name: ${NODE_NAME}

    network.host: 0.0.0.0

    discovery.seed_hosts:
      {{- range $i := until (int .Values.replicas) }}
      - replica-{{ $i }}.{{ include "opensearch.name" $ }}.${LOCATION}.{{ $.Values.global.cpln.gvc }}.cpln.local
      {{- end }}

    cluster.initial_cluster_manager_nodes:
      {{- range $i := until (int .Values.replicas) }}
      - replica-{{ $i }}.{{ include "opensearch.name" $ }}.${LOCATION}.{{ $.Values.global.cpln.gvc }}.cpln.local
      {{- end }}

    path.data: /usr/share/opensearch/data

    http.port: 9200

    transport.port: 9300


    # Disable unnecessary plugins for now

    plugins.security.disabled: true

    EOF


    echo "Generated config file:"

    cat /usr/share/opensearch/config/opensearch.yml


    # --- Run OpenSearch ---

    exec /usr/share/opensearch/opensearch-docker-entrypoint.sh
