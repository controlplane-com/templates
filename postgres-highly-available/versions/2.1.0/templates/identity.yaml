{{- include "pg-ha.validateBackupConfig" . -}}
kind: identity
gvc: {{ .Values.global.cpln.gvc }}
name: {{ include "pg-ha.identity.name" . }}
description: Postgres Highly Available identity
tags:
  {{- include "pg-ha.tags" . | nindent 4 }}
{{- if and .Values.backup.enabled (eq .Values.backup.provider "aws") }}
aws:
  cloudAccountLink: //cloudaccount/{{ .Values.backup.aws.cloudAccountName }}
  policyRefs:
    - cpln-connector
    - aws::ReadOnlyAccess
    - "{{ .Values.backup.aws.policyName }}"
{{- end }}
{{- if and .Values.backup.enabled (eq .Values.backup.provider "gcp") }}
gcp:
  bindings:
    - resource: //storage.googleapis.com/projects/_/buckets/{{ .Values.backup.gcp.bucket }}
      roles:
        - roles/storage.objectAdmin
  cloudAccountLink: //cloudaccount/{{ .Values.backup.gcp.cloudAccountName }}
  scopes:
    - https://www.googleapis.com/auth/cloud-platform
{{- end }}