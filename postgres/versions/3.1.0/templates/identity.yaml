{{- include "pg.validateBackupConfig" . -}}
kind: identity
name: {{ include "postgres.identity.name" . }}
description: Postgres identity
gvc: {{ .Values.global.cpln.gvc }}
tags:
  {{- include "pg.tags" . | nindent 4 }}
{{- if eq .Values.backup.provider "aws" }}
aws:
  cloudAccountLink: //cloudaccount/{{ .Values.backup.aws.cloudAccountName }}
  policyRefs:
    - cpln-connector
    - aws::ReadOnlyAccess
    - {{ .Values.backup.aws.policyName | quote }}
{{- end }}
{{- if eq .Values.backup.provider "gcp" }}
gcp:
  bindings:
    - resource: //storage.googleapis.com/projects/_/buckets/{{ .Values.backup.gcp.bucket }}
      roles:
        - roles/storage.objectAdmin
  cloudAccountLink: //cloudaccount/{{ .Values.backup.gcp.cloudAccountName }}
  scopes:
    - https://www.googleapis.com/auth/cloud-platform
{{- end }}