---
kind: secret
name: {{ .Release.Name }}-strapi-secrets
description: Strapi application secrets
tags: {{- include "strapi.tags" . | nindent 4 }}
type: dictionary
data:
  appKeys: {{ .Values.strapi.secrets.appKeys | quote }}
  apiTokenSalt: {{ .Values.strapi.secrets.apiTokenSalt | quote }}
  adminJwtSecret: {{ .Values.strapi.secrets.adminJwtSecret | quote }}
  transferTokenSalt: {{ .Values.strapi.secrets.transferTokenSalt | quote }}
  jwtSecret: {{ .Values.strapi.secrets.jwtSecret | quote }}
---
kind: secret
name: {{ .Release.Name }}-strapi-startup
description: Strapi startup script
tags: {{- include "strapi.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/bin/bash
    set -euo pipefail

    DB_HOST="{{ .Release.Name }}-pg-db.{{ .Values.global.cpln.gvc }}.cpln.local"
    DB_PORT=5432
    MAX_RETRIES=60
    SLEEP_SECONDS=5

    echo "Waiting for PostgreSQL at ${DB_HOST}:${DB_PORT}..."

    for i in $(seq 1 $MAX_RETRIES); do
      if pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
        echo "PostgreSQL is ready!"
        break
      fi
      echo "Attempt $i/$MAX_RETRIES: Postgres not ready, retrying in ${SLEEP_SECONDS}s..."
      sleep "$SLEEP_SECONDS"
    done

    if ! pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
      echo "PostgreSQL did not become ready. Exiting."
      exit 1
    fi

    echo "Starting Strapi..."
    cd /srv/app
    exec npm run start
