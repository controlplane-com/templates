kind: workload
name: {{ .Release.Name }}-strapi
gvc: {{ .Values.global.cpln.gvc }}
tags: {{- include "strapi.tags" . | nindent 4 }}
spec:
  type: serverless
  identityLink: //identity/{{ .Release.Name }}-strapi-identity
  {{- if .Values.strapi.imagePullSecret }}
  localOptions:
    - location: '*'
      pullSecretLinks:
        - //secret/{{ .Values.strapi.imagePullSecret }}
  {{- end }}
  containers:
    - name: strapi
      cpu: {{ .Values.strapi.resources.cpu }}
      memory: {{ .Values.strapi.resources.memory }}
      image: {{ .Values.strapi.image }}
      inheritEnv: false
      env:
        # Database configuration
        - name: DATABASE_CLIENT
          value: postgres
        - name: DATABASE_HOST
          value: cpln://secret/{{ .Release.Name }}-strapi-db.host
        - name: DATABASE_PORT
          value: cpln://secret/{{ .Release.Name }}-strapi-db.port
        - name: DATABASE_NAME
          value: cpln://secret/{{ .Release.Name }}-strapi-db.name
        - name: DATABASE_USERNAME
          value: cpln://secret/{{ .Release.Name }}-strapi-db.username
        - name: DATABASE_PASSWORD
          value: cpln://secret/{{ .Release.Name }}-strapi-db.password
        - name: DATABASE_SSL
          value: cpln://secret/{{ .Release.Name }}-strapi-db.ssl
        # Strapi application secrets
        - name: APP_KEYS
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.appKeys
        - name: API_TOKEN_SALT
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.apiTokenSalt
        - name: ADMIN_JWT_SECRET
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.adminJwtSecret
        - name: TRANSFER_TOKEN_SALT
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.transferTokenSalt
        - name: JWT_SECRET
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.jwtSecret
        # Server configuration
        - name: HOST
          value: "0.0.0.0"
        - name: PORT
          value: "1337"
        - name: NODE_ENV
          value: production
      ports:
        - number: 1337
          protocol: http
  defaultOptions:
    autoscaling:
      maxConcurrency: 1000
      maxScale: {{ .Values.strapi.autoscaling.maxScale }}
      metric: concurrency
      minScale: {{ .Values.strapi.autoscaling.minScale }}
      scaleToZeroDelay: 300
      target: 100
    capacityAI: true
    debug: false
    suspend: false
    timeoutSeconds: 30
  firewallConfig:
    external:
      inboundAllowCIDR:
        - 0.0.0.0/0
      outboundAllowCIDR:
        - 0.0.0.0/0
