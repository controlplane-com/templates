kind: workload
name: {{ .Release.Name }}-strapi
gvc: {{ .Values.global.cpln.gvc }}
tags: {{- include "strapi.tags" . | nindent 4 }}
spec:
  type: serverless
  identityLink: //identity/{{ .Release.Name }}-strapi-identity
  containers:
    - name: strapi
      cpu: {{ .Values.strapi.resources.cpu }}
      memory: {{ .Values.strapi.resources.memory }}
      image: {{ .Values.strapi.image }}
      inheritEnv: false
      env:
        - name: DATABASE_CLIENT
          value: postgres
        - name: DATABASE_HOST
          value: {{ .Release.Name }}-pg-db.{{ .Values.global.cpln.gvc }}.cpln.local
        - name: DATABASE_PORT
          value: "5432"
        - name: DATABASE_NAME
          value: {{ .Values.postgres.config.database }}
        - name: DATABASE_USERNAME
          value: cpln://secret/{{ .Release.Name }}-pg-config.username
        - name: DATABASE_PASSWORD
          value: cpln://secret/{{ .Release.Name }}-pg-config.password
        - name: APP_KEYS
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.appKeys
        - name: API_TOKEN_SALT
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.apiTokenSalt
        - name: ADMIN_JWT_SECRET
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.adminJwtSecret
        - name: TRANSFER_TOKEN_SALT
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.transferTokenSalt
        - name: JWT_SECRET
          value: cpln://secret/{{ .Release.Name }}-strapi-secrets.jwtSecret
      ports:
        - number: 1337
          protocol: http
      command: /bin/bash
      args:
        - /opt/strapi/start.sh
      volumes:
        - path: /opt/strapi/start.sh
          recoveryPolicy: retain
          uri: cpln://secret/{{ .Release.Name }}-strapi-startup.payload
  defaultOptions:
    autoscaling:
      maxConcurrency: 1000
      maxScale: {{ .Values.strapi.autoscaling.maxScale }}
      metric: concurrency
      minScale: {{ .Values.strapi.autoscaling.minScale }}
      scaleToZeroDelay: 300
      target: 100
    capacityAI: true
    debug: false
    suspend: false
    timeoutSeconds: 30
  firewallConfig:
    external:
      inboundAllowCIDR:
        - 0.0.0.0/0
      outboundAllowCIDR:
        - 0.0.0.0/0
