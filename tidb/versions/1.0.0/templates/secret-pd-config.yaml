---
kind: secret
name: tidb-pd-startup
description: TiDB placement driver startup script
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # Runtime environment from Control Plane
    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}
    GVC="{{ .Values.gvc.name }}"

    # Extract replica index from HOSTNAME
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    WORKLOAD_NAME="{{ .Release.Name }}-pd"

    # Self FQDN for advertise
    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"

    # Build the PD cluster peer list using only index 0 of each location
    JOIN_HOSTS=""
    LOCATIONS="{{ range .Values.gvc.locations }}{{ .name }} {{ end }}"

    for loc in $LOCATIONS; do
      peer_name="${loc}-0"
      peer_url="http://replica-0.${WORKLOAD_NAME}.${loc}.${GVC}.cpln.local:2380"
      JOIN_HOSTS="${JOIN_HOSTS},${peer_name}=${peer_url}"
    done
    JOIN_HOSTS=${JOIN_HOSTS#,}  # remove leading comma

    echo "Generating pd.toml for $SELF_FQDN with peers: $JOIN_HOSTS"

    # Ensure /data exists
    mkdir -p /data

    # Determine if this is the bootstrap node
    FIRST_LOCATION=$(echo $LOCATIONS | awk '{print $1}')
    if [[ "$LOCATION" == "$FIRST_LOCATION" && "$REPLICA_INDEX" == "0" ]]; then
      INITIAL_CLUSTER_STATE="new"
      FORCE_NEW_CLUSTER=true
      echo "This is the primary bootstrap replica."
    else
      INITIAL_CLUSTER_STATE="existing"
      FORCE_NEW_CLUSTER=false
      echo "This replica will join the existing cluster."
    fi

    # Ensure /etc/pd exists
    mkdir -p /etc/pd

    # Generate the PD config file
    cat > /etc/pd/pd.toml <<EOF
    name = "${LOCATION}-${REPLICA_INDEX}"
    data-dir = "/data"

    client-urls = "http://0.0.0.0:2379"
    peer-urls   = "http://0.0.0.0:2380"
    advertise-client-urls = "http://${SELF_FQDN}:2379"
    advertise-peer-urls   = "http://${SELF_FQDN}:2380"

    initial-cluster = "${JOIN_HOSTS}"
    initial-cluster-state = "${INITIAL_CLUSTER_STATE}"
    initial-cluster-token = "pd-cluster"
    EOF

    echo "pd.toml generated successfully at /etc/pd/pd.toml"
    echo "initial-cluster-state=${INITIAL_CLUSTER_STATE}, force-new-cluster=${FORCE_NEW_CLUSTER}"

    # Start PD using the config file
    if [[ "$FORCE_NEW_CLUSTER" == "true" ]]; then
      echo "Starting PD with --force-new-cluster"
      exec /pd-server --config=/etc/pd/pd.toml --force-new-cluster
    else
      exec /pd-server --config=/etc/pd/pd.toml
    fi