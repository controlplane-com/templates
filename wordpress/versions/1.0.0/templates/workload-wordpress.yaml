kind: workload
name: {{ include "wp.name" . }}
gvc: {{ .Values.cpln.gvc }}
tags:
  {{- include "wp.tags" . | nindent 2 }}
spec:
  type: stateful
  identityLink: //identity/{{ include "wp.name" . }}
  containers:
    - name: wp
      args:
        - '--ignore-db-dir=lost+found'
      env:
        - name: WORDPRESS_DB_HOST
          value: '{{ include "wp.name" . }}-mysql.{{ .Values.cpln.gvc }}.cpln.local'
        - name: WORDPRESS_DB_USER
          value: 'cpln://secret/{{ include "wp.secretName" . }}.MYSQL_USER'
        - name: WORDPRESS_DB_PASSWORD
          value: 'cpln://secret/{{ include "wp.secretName" . }}.MYSQL_PASSWORD'
        - name: WORDPRESS_TABLE_PREFIX
          value: {{ .Values.config.wpTablePrefix }}
      image: 'wordpress:6'
      inheritEnv: false
      cpu: {{ .Values.resources.cpu }}
      memory: {{ .Values.resources.memory }}
      ports:
        - number: 80
          protocol: http
  defaultOptions:
    autoscaling:
      metric: disabled
      minScale: 1
      maxScale: 1
    capacityAI: false
    timeoutSeconds: {{ .Values.timeoutSeconds | int }}
  firewallConfig:
    external:
      inboundAllowCIDR:
        - 0.0.0.0/0
    internal:
      inboundAllowType: none